---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - scripts/install-gitleaks.sh
  - hooks/pre-commit
autonomous: true
requirements:
  - BOOT-04

must_haves:
  truths:
    - "Attempting to commit a file containing a secret is blocked by the pre-commit hook with the gitleaks report shown (file, line, matched rule)"
    - "gitleaks v8.30.0 is installed to /usr/local/bin/gitleaks with the correct binary for the running architecture"
    - "The full git history is scanned for secrets on first setup; secrets in history cause bootstrap to fail with a clear message"
    - "The pre-commit hook is a standalone bash script — no Python, no pre-commit framework"
    - "gitleaks install is idempotent — re-running skips if correct version already present"
  artifacts:
    - path: "scripts/install-gitleaks.sh"
      provides: "install_gitleaks(), install_pre_commit_hook(), scan_git_history() — sourced by bootstrap.sh"
      min_lines: 60
    - path: "hooks/pre-commit"
      provides: "Source-controlled pre-commit hook script, copied to .git/hooks/pre-commit by install_pre_commit_hook()"
      min_lines: 15
  key_links:
    - from: "scripts/install-gitleaks.sh"
      to: "/usr/local/bin/gitleaks"
      via: "install -m 755 binary to INSTALL_PATH"
      pattern: "INSTALL_PATH.*usr/local/bin/gitleaks"
    - from: "scripts/install-gitleaks.sh"
      to: "hooks/pre-commit"
      via: "cp hooks/pre-commit to .git/hooks/pre-commit"
      pattern: "cp.*hooks/pre-commit"
    - from: "hooks/pre-commit"
      to: "gitleaks"
      via: "gitleaks protect --staged --redact"
      pattern: "gitleaks protect --staged"
    - from: "scripts/install-gitleaks.sh"
      to: "~/.dotfiles/.installed"
      via: "echo 'file:/usr/local/bin/gitleaks' >> MANIFEST_FILE"
      pattern: "MANIFEST_FILE"
---

<objective>
Create the gitleaks installer script and source-controlled pre-commit hook that enforce secret prevention.

Purpose: BOOT-04 requires that attempting to commit a secret blocks the commit and shows the full gitleaks report. This plan installs gitleaks as a static binary (no apt, no Python), wires it into .git/hooks/pre-commit, and performs a one-time full history scan.
Output: scripts/install-gitleaks.sh (sourced functions), hooks/pre-commit (source-controlled hook).
</objective>

<execution_context>
@/Users/elmartinez85/.claude/get-shit-done/workflows/execute-plan.md
@/Users/elmartinez85/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hooks/pre-commit source-controlled hook</name>
  <files>
    hooks/pre-commit
  </files>
  <action>
Create `hooks/pre-commit` — this is the source-controlled hook script. bootstrap.sh copies it to `.git/hooks/pre-commit` at install time.

**Critical decisions from research:**
- Standalone bash script — NO Python, NO `pre-commit` framework (violates zero-dependency constraint)
- Uses `gitleaks protect --staged --redact` for staged changes (confirmed working in v8.30.0)
- Checks `command -v gitleaks` (NOT `which` — not POSIX, inconsistent behavior)
- File must be marked executable in the repo

```bash
#!/usr/bin/env bash
# hooks/pre-commit
# Source-controlled gitleaks pre-commit hook.
# Installed to .git/hooks/pre-commit by bootstrap.sh (scripts/install-gitleaks.sh).
#
# Deprecation note: gitleaks protect --staged is deprecated/hidden since v8.19.0
# but confirmed functional as of v8.30.0. Pinned version controls surprises.
# For history scanning, use `gitleaks git` (the modern replacement for `gitleaks detect`).

set -euo pipefail

if ! command -v gitleaks >/dev/null 2>&1; then
  echo "ERROR: gitleaks not found in PATH." >&2
  echo "Run bootstrap.sh to install it: sudo bash ~/.dotfiles/bootstrap.sh" >&2
  exit 1
fi

echo "==> [gitleaks] Scanning staged changes for secrets..."

if ! gitleaks protect --staged --redact; then
  echo "" >&2
  echo "ERROR: Secret(s) detected in staged changes. Commit blocked." >&2
  echo "Review the gitleaks report above (file, line, matched rule)." >&2
  echo "Remove the secret, then re-stage and commit." >&2
  exit 1
fi

echo "==> [gitleaks] No secrets detected — commit allowed."
```

After creating the file, mark it executable:
```bash
chmod +x hooks/pre-commit
```
  </action>
  <verify>
    bash -n hooks/pre-commit && echo "hooks/pre-commit: syntax OK"
    ls -la hooks/pre-commit | grep -E "^-rwx"
    grep "gitleaks protect --staged" hooks/pre-commit
    grep "command -v gitleaks" hooks/pre-commit
  </verify>
  <done>
    - hooks/pre-commit exists and passes bash -n
    - File is executable (chmod +x confirmed)
    - Contains `gitleaks protect --staged --redact` (not gitleaks detect)
    - Contains `command -v gitleaks` check (not `which`)
    - Contains clear error message directing user to bootstrap.sh if gitleaks missing
  </done>
</task>

<task type="auto">
  <name>Task 2: Create scripts/install-gitleaks.sh installer</name>
  <files>
    scripts/install-gitleaks.sh
  </files>
  <action>
Create `scripts/install-gitleaks.sh` — sourced by bootstrap.sh (not executed directly). Exports three functions: `install_gitleaks`, `install_pre_commit_hook`, `scan_git_history`.

**Critical constraints from research:**
- Uses `ARCH` exported by bootstrap.sh (set via `os_detect_arch`) — do NOT re-detect arch here
- Install path: `/usr/local/bin/gitleaks` (requires root — bootstrap.sh already enforces this via `os_require_root`)
- Version: `8.30.0` (pinned; single place to update)
- Download URL format: `gitleaks_${GITLEAKS_VERSION}_linux_${ARCH}.tar.gz`
- Use `curl --fail --silent --show-error --location --retry 3 --retry-delay 2` (built-in retry; do not hand-roll)
- Idempotency: skip if already installed at the correct version (check binary + version string)
- Manifest format: `file:/usr/local/bin/gitleaks` and `hook:pre-commit:<hook_path>`
- `git rev-parse --git-dir` to find .git/hooks/ reliably (handles submodules and worktrees)
- For history scan: use `gitleaks git --source .` (modern replacement for deprecated `gitleaks detect`)

```bash
#!/usr/bin/env bash
# scripts/install-gitleaks.sh
# Sourced by bootstrap.sh — provides install_gitleaks, install_pre_commit_hook, scan_git_history
# Do NOT execute directly.
if [[ -n "${_SCRIPT_INSTALL_GITLEAKS_LOADED:-}" ]]; then return 0; fi
_SCRIPT_INSTALL_GITLEAKS_LOADED=1

GITLEAKS_VERSION="8.30.0"
GITLEAKS_INSTALL_PATH="/usr/local/bin/gitleaks"

install_gitleaks() {
  log_step "Checking gitleaks ${GITLEAKS_VERSION}..."

  # Idempotency: skip if already installed at the correct version
  if [[ -x "$GITLEAKS_INSTALL_PATH" ]]; then
    local installed_ver
    installed_ver="$("$GITLEAKS_INSTALL_PATH" version 2>/dev/null || echo "unknown")"
    if [[ "$installed_ver" == *"${GITLEAKS_VERSION}"* ]]; then
      log_info "gitleaks ${GITLEAKS_VERSION} already installed — skipping"
      _SUMMARY_SKIPPED+=("gitleaks ${GITLEAKS_VERSION}")
      return 0
    fi
  fi

  if [[ "${DRY_RUN:-false}" == "true" ]]; then
    log_info "[DRY RUN] Would install gitleaks ${GITLEAKS_VERSION} (${ARCH}) to ${GITLEAKS_INSTALL_PATH}"
    return 0
  fi

  local url="https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_${ARCH}.tar.gz"
  log_step "Downloading gitleaks ${GITLEAKS_VERSION} for linux/${ARCH}..."

  local tmpdir
  tmpdir="$(mktemp -d)"
  # Clean up temp dir on function return regardless of outcome
  trap 'rm -rf "$tmpdir"' RETURN

  curl --fail --silent --show-error --location \
    --retry 3 --retry-delay 2 \
    "$url" | tar -xz -C "$tmpdir"

  install -m 755 "${tmpdir}/gitleaks" "$GITLEAKS_INSTALL_PATH"

  log_success "gitleaks ${GITLEAKS_VERSION} installed at ${GITLEAKS_INSTALL_PATH}"
  echo "file:${GITLEAKS_INSTALL_PATH}" >> "$MANIFEST_FILE"
  _SUMMARY_INSTALLED+=("gitleaks ${GITLEAKS_VERSION}")
}

install_pre_commit_hook() {
  log_step "Installing pre-commit hook..."

  local hook_src="${DOTFILES_DIR}/hooks/pre-commit"
  local git_dir
  git_dir="$(git -C "$DOTFILES_DIR" rev-parse --git-dir)"
  local hook_dst="${git_dir}/hooks/pre-commit"

  # Idempotency: skip if hook already installed and matches source
  if [[ -f "$hook_dst" ]] && diff -q "$hook_src" "$hook_dst" >/dev/null 2>&1; then
    log_info "pre-commit hook already installed and up to date — skipping"
    _SUMMARY_SKIPPED+=("pre-commit hook")
    return 0
  fi

  if [[ "${DRY_RUN:-false}" == "true" ]]; then
    log_info "[DRY RUN] Would copy ${hook_src} to ${hook_dst}"
    return 0
  fi

  mkdir -p "${git_dir}/hooks"
  cp "$hook_src" "$hook_dst"
  chmod +x "$hook_dst"

  log_success "pre-commit hook installed at ${hook_dst}"
  echo "hook:pre-commit:${hook_dst}" >> "$MANIFEST_FILE"
  _SUMMARY_INSTALLED+=("pre-commit hook (gitleaks)")
}

scan_git_history() {
  log_step "Scanning full git history for secrets (one-time check)..."

  if [[ "${DRY_RUN:-false}" == "true" ]]; then
    log_info "[DRY RUN] Would run: gitleaks git --source ${DOTFILES_DIR} --verbose"
    return 0
  fi

  if ! gitleaks git --source "$DOTFILES_DIR" --verbose; then
    log_error "Secrets detected in git history. See gitleaks report above."
    log_error "Remove the secrets, rewrite history (git filter-repo or BFG), then re-run bootstrap."
    return 1
  fi

  log_success "No secrets found in git history"
  _SUMMARY_INSTALLED+=("gitleaks history scan (clean)")
}
```

**Note on MANIFEST_FILE and DOTFILES_DIR:** These are exported by bootstrap.sh before sourcing this script. Do not redeclare them here.

**Note on _SUMMARY_INSTALLED and _SUMMARY_SKIPPED:** These arrays are declared in bootstrap.sh. Functions append to them with `+=`.
  </action>
  <verify>
    bash -n scripts/install-gitleaks.sh && echo "install-gitleaks.sh: syntax OK"
    grep "GITLEAKS_VERSION=\"8.30.0\"" scripts/install-gitleaks.sh
    grep "gitleaks git --source" scripts/install-gitleaks.sh
    grep "gitleaks protect --staged" hooks/pre-commit
    grep "gitleaks_\${GITLEAKS_VERSION}_linux_\${ARCH}" scripts/install-gitleaks.sh
    grep "curl --fail --silent --show-error --location" scripts/install-gitleaks.sh
    grep "retry 3" scripts/install-gitleaks.sh
    grep "MANIFEST_FILE" scripts/install-gitleaks.sh
    grep "rev-parse --git-dir" scripts/install-gitleaks.sh
  </verify>
  <done>
    - scripts/install-gitleaks.sh passes bash -n
    - GITLEAKS_VERSION pinned to 8.30.0
    - Uses gitleaks git (not gitleaks detect) for history scan
    - Download URL uses ${ARCH} variable (not hardcoded)
    - curl uses --retry 3 --retry-delay 2 (no hand-rolled retry)
    - install_gitleaks() skips if correct version already installed
    - install_pre_commit_hook() skips if hook exists and matches source
    - Both functions write to MANIFEST_FILE on successful install
    - scan_git_history() uses gitleaks git --source (not deprecated gitleaks detect)
  </done>
</task>

</tasks>

<verification>
Run from repo root:
1. `bash -n scripts/install-gitleaks.sh hooks/pre-commit` — both pass syntax check
2. `grep "GITLEAKS_VERSION" scripts/install-gitleaks.sh` — shows "8.30.0"
3. `grep "gitleaks git --source" scripts/install-gitleaks.sh` — present (NOT gitleaks detect)
4. `grep "gitleaks protect --staged --redact" hooks/pre-commit` — present
5. `grep "command -v gitleaks" hooks/pre-commit` — present (not `which`)
6. `ls -la hooks/pre-commit` — shows executable bit set
7. `bash -c 'ARCH=x86_64; GITLEAKS_VERSION=8.30.0; URL="https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_${ARCH}.tar.gz"; echo $URL'` — produces valid URL
</verification>

<success_criteria>
- hooks/pre-commit: bash syntax clean, executable, uses gitleaks protect --staged --redact, uses command -v
- scripts/install-gitleaks.sh: bash syntax clean, gitleaks pinned to 8.30.0, idempotent installs with version check, curl uses built-in retry, manifest entries written for both gitleaks binary and hook
- History scan uses gitleaks git (not deprecated gitleaks detect)
- Zero Python dependencies — pure bash + gitleaks binary only
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md` with:
- Confirmation that hooks/pre-commit and scripts/install-gitleaks.sh are created and syntax-clean
- The exact download URL template used for gitleaks
- The manifest entry formats written (for future phases to extend)
- Note on gitleaks protect deprecation status and the version pin
- Any deviations from the plan and why
</output>
