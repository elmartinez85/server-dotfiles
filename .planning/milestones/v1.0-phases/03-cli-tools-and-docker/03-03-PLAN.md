---
phase: 03-cli-tools-and-docker
plan: 03
type: execute
wave: 2
depends_on:
  - 03-01
files_modified:
  - scripts/install-docker.sh
autonomous: true
requirements:
  - DOCK-01
  - DOCK-02
  - DOCK-03
  - DOCK-04

must_haves:
  truths:
    - "scripts/install-docker.sh exists with four functions: install_docker_engine, verify_docker_running, add_user_to_docker_group, install_lazydocker"
    - "Docker Engine is installed via the official apt repository method (not get.docker.com convenience script)"
    - "distro detection uses /etc/os-release ID to switch between ubuntu and debian repo URLs — handles both Ubuntu and RPi OS Bookworm arm64"
    - "install_docker_engine is idempotent: skips if docker is already installed and running"
    - "bootstrap user is added to the docker group with a clear re-login warning; docker run hello-world is NOT executed inside bootstrap"
    - "lazydocker is installed from GitHub Releases using the flat archive pattern (binary at root, not in a subdirectory)"
    - "Docker Compose v2 plugin (docker compose) is installed as part of the docker-compose-plugin apt package"
  artifacts:
    - path: "scripts/install-docker.sh"
      provides: "Docker Engine, Compose plugin, docker group membership, lazydocker installer"
      min_lines: 120
      contains: "install_docker_engine"
  key_links:
    - from: "scripts/install-docker.sh"
      to: "lib/versions.sh"
      via: "source ${DOTFILES_DIR}/lib/versions.sh"
      pattern: "source.*lib/versions\\.sh"
    - from: "install_docker_engine"
      to: "download.docker.com"
      via: "apt repository — docker.list sources file"
      pattern: "download\\.docker\\.com/linux"
    - from: "add_user_to_docker_group"
      to: "usermod -aG docker"
      via: "usermod"
      pattern: "usermod -aG docker"
    - from: "install_lazydocker"
      to: "/usr/local/bin/lazydocker"
      via: "install -m 755 (flat archive)"
      pattern: "install -m 755.*lazydocker"
---

<objective>
Create scripts/install-docker.sh with four functions: install_docker_engine (Docker CE + Compose plugin via official apt repo), verify_docker_running (systemctl check), add_user_to_docker_group (with re-login warning), and install_lazydocker (GitHub Releases flat archive).

Purpose: Covers DOCK-01 through DOCK-04. Docker requires a distinct install path from the CLI tools — the official apt repository method handles both Ubuntu and RPi OS Bookworm arm64 and is fully idempotent. The convenience script at get.docker.com has a hardcoded 20-second sleep on re-run and is explicitly documented as unsuitable for upgrades.

Output: scripts/install-docker.sh (~160 lines) with four functions ready to be wired into bootstrap.sh in Plan 04.
</objective>

<execution_context>
@/Users/elmartinez85/.claude/get-shit-done/workflows/execute-plan.md
@/Users/elmartinez85/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-cli-tools-and-docker/03-CONTEXT.md
@.planning/phases/03-cli-tools-and-docker/03-RESEARCH.md
@scripts/install-gitleaks.sh
@.planning/phases/03-cli-tools-and-docker/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scripts/install-docker.sh with four Docker functions</name>
  <files>scripts/install-docker.sh</files>
  <action>
Create scripts/install-docker.sh. Follow the exact header/guard pattern of install-shell.sh and install-gitleaks.sh.

**File header:**
```bash
#!/usr/bin/env bash
# scripts/install-docker.sh
# Sourced by bootstrap.sh — provides install_docker_engine, verify_docker_running,
# add_user_to_docker_group, install_lazydocker
# Do NOT execute directly.
# shellcheck source=lib/log.sh
# shellcheck source=lib/versions.sh
if [[ -n "${_SCRIPT_INSTALL_DOCKER_LOADED:-}" ]]; then return 0; fi
_SCRIPT_INSTALL_DOCKER_LOADED=1

# Source canonical version store — provides LAZYDOCKER_VERSION
# shellcheck source=lib/versions.sh
source "${DOTFILES_DIR}/lib/versions.sh"
```

**Function 1: install_docker_engine**

Implements DOCK-01 and DOCK-02. Uses official apt repository method. CRITICAL: Do NOT use get.docker.com — it has a hardcoded `sleep 20` on re-run and is not designed for provisioning scripts.

Idempotency: skip if `command -v docker &>/dev/null && systemctl is-active --quiet docker 2>/dev/null`. This checks both binary presence and daemon status — a partial install (binary but no daemon) will correctly reinstall.

Distro detection for Docker repo URL: RPi OS Bookworm reports `ID=debian` in /etc/os-release. Use subshell sourcing pattern: `os_id="$(. /etc/os-release && echo "$ID")"`. Map: ubuntu→ubuntu, debian→debian, raspbian→debian (fallback to debian for anything else). This is CRITICAL: using `download.docker.com/linux/raspbian` for arm64 will fail — the raspbian repo has no binary-arm64/ directory.

DRY_RUN guard: same pattern as other install functions.

Full implementation:
```bash
install_docker_engine() {
  log_step "Checking Docker Engine..."

  if command -v docker &>/dev/null && systemctl is-active --quiet docker 2>/dev/null; then
    log_info "Docker already installed and running — skipping"
    _SUMMARY_SKIPPED+=("Docker Engine")
    return 0
  fi

  if [[ "${DRY_RUN:-false}" == "true" ]]; then
    log_info "[DRY RUN] Would install Docker Engine via official apt repository"
    return 0
  fi

  log_step "Installing Docker Engine via official apt repository..."

  local os_id docker_repo_distro version_codename
  os_id="$(. /etc/os-release && echo "$ID")"
  case "$os_id" in
    ubuntu)   docker_repo_distro="ubuntu" ;;
    debian)   docker_repo_distro="debian" ;;
    raspbian) docker_repo_distro="debian" ;;
    *)        docker_repo_distro="debian" ;;
  esac

  version_codename="$(. /etc/os-release && echo "${VERSION_CODENAME:-$UBUNTU_CODENAME}")"

  apt-get update -qq
  apt-get install -y ca-certificates curl

  install -m 0755 -d /etc/apt/keyrings
  curl --fail --silent --show-error --location \
    "https://download.docker.com/linux/${docker_repo_distro}/gpg" \
    -o /etc/apt/keyrings/docker.asc
  chmod a+r /etc/apt/keyrings/docker.asc

  # Overwrite existing docker.list — idempotent
  printf 'deb [arch=%s signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/%s %s stable\n' \
    "$(dpkg --print-architecture)" "$docker_repo_distro" "$version_codename" \
    > /etc/apt/sources.list.d/docker.list

  apt-get update -qq
  apt-get install -y \
    docker-ce \
    docker-ce-cli \
    containerd.io \
    docker-buildx-plugin \
    docker-compose-plugin

  log_success "Docker Engine and Compose plugin installed"
  echo "file:/usr/bin/docker" >> "$MANIFEST_FILE"
  _SUMMARY_INSTALLED+=("Docker Engine")
  _SUMMARY_INSTALLED+=("docker compose plugin (DOCK-02)")
}
```

**Function 2: verify_docker_running**

Implements in-bootstrap Docker daemon verification. Does NOT run `docker run hello-world` — group membership is not active in the same session as usermod. Uses `systemctl is-active --quiet docker`.

```bash
verify_docker_running() {
  log_step "Verifying Docker daemon is running..."
  if systemctl is-active --quiet docker; then
    log_success "Docker daemon is active"
  else
    log_warn "Docker daemon not active — attempting to enable and start..."
    systemctl enable --now docker || log_warn "Could not start Docker daemon — check journalctl -u docker"
    _SUMMARY_WARNINGS+=("Docker daemon required manual start — verify with: systemctl status docker")
  fi
}
```

**Function 3: add_user_to_docker_group**

Implements DOCK-03. Adds $SUDO_USER (or root) to the docker group. Idempotent via `id -nG` check. Logs a mandatory re-login warning because group membership is NOT active in the current bootstrap session.

CRITICAL: Do NOT run `docker run hello-world` here. Do NOT use `newgrp docker` (creates a subshell that breaks set -eEuo pipefail). The verify.sh script (Plan 04) handles post-relogin verification.

```bash
add_user_to_docker_group() {
  local target_user="${SUDO_USER:-root}"
  log_step "Adding ${target_user} to docker group..."

  if ! getent group docker &>/dev/null; then
    groupadd docker
    log_info "Created docker group"
  fi

  if id -nG "$target_user" 2>/dev/null | grep -qw docker; then
    log_info "${target_user} is already in the docker group — skipping"
    _SUMMARY_SKIPPED+=("docker group membership")
    return 0
  fi

  usermod -aG docker "$target_user"
  log_success "${target_user} added to docker group"
  log_warn "IMPORTANT: Docker group membership takes effect after re-login."
  log_warn "Run 'bash ~/.dotfiles/scripts/verify.sh' after opening a new SSH session."
  _SUMMARY_WARNINGS+=("docker group: re-login required before running docker commands as ${target_user}")
}
```

**Function 4: install_lazydocker**

Implements DOCK-04. GitHub Releases flat archive — binary `lazydocker` is directly in the extracted directory (no subdirectory). lazydocker uses `Linux_x86_64` / `Linux_arm64` naming in its release URLs (capital L in Linux, underscore separator).

Idempotency: check binary exists and version matches LAZYDOCKER_VERSION from versions.sh.

URL pattern: `https://github.com/jesseduffield/lazydocker/releases/download/v${version}/lazydocker_${version}_Linux_${arch}.tar.gz`
- x86_64: arch=`x86_64`; arm64: arch=`arm64` (lazydocker uses x86_64/arm64, matching $ARCH directly)

```bash
install_lazydocker() {
  local version="${LAZYDOCKER_VERSION}"
  local install_path="/usr/local/bin/lazydocker"

  log_step "Checking lazydocker ${version}..."

  if [[ -x "$install_path" ]]; then
    local installed_ver
    installed_ver="$("$install_path" --version 2>/dev/null | head -1 || echo "unknown")"
    if [[ "$installed_ver" == *"${version}"* ]]; then
      log_info "lazydocker ${version} already installed — skipping"
      _SUMMARY_SKIPPED+=("lazydocker ${version}")
      return 0
    fi
    log_info "lazydocker version mismatch — reinstalling"
  fi

  if [[ "${DRY_RUN:-false}" == "true" ]]; then
    log_info "[DRY RUN] Would install lazydocker ${version} (${ARCH})"
    return 0
  fi

  # lazydocker uses x86_64/arm64 matching $ARCH directly
  local url="https://github.com/jesseduffield/lazydocker/releases/download/v${version}/lazydocker_${version}_Linux_${ARCH}.tar.gz"
  local tmpdir
  tmpdir="$(mktemp -d)"
  trap 'rm -rf "$tmpdir"' RETURN

  curl --fail --silent --show-error --location --retry 3 --retry-delay 2 \
    "$url" | tar -xz -C "$tmpdir"

  # lazydocker is a FLAT archive — binary is directly in $tmpdir (no subdirectory)
  install -m 755 "${tmpdir}/lazydocker" "$install_path"

  log_success "lazydocker ${version} installed at ${install_path}"
  echo "file:${install_path}" >> "$MANIFEST_FILE"
  _SUMMARY_INSTALLED+=("lazydocker ${version}")
}
```

Note on lazydocker --version output format: the output format is LOW confidence (per RESEARCH.md sources). If `--version` output does not contain the version string during idempotency check, the function will reinstall on every run. This is acceptable fallback behavior — functionally correct, just not skipping.
  </action>
  <verify>
bash -n scripts/install-docker.sh && echo "Syntax OK" && grep -c "^install_\|^verify_\|^add_user" scripts/install-docker.sh | xargs -I{} bash -c '[[ {} -eq 4 ]] && echo "4 functions found"'
  </verify>
  <done>
scripts/install-docker.sh exists. bash -n passes. File contains install_docker_engine, verify_docker_running, add_user_to_docker_group, and install_lazydocker. install_docker_engine uses official apt repo (not get.docker.com). distro detection present. docker run hello-world is NOT in the file. lazydocker uses flat archive extraction.
  </done>
</task>

</tasks>

<verification>
1. `bash -n scripts/install-docker.sh` — no syntax errors
2. `grep "get.docker.com" scripts/install-docker.sh` — returns nothing (convenience script NOT used)
3. `grep "download.docker.com/linux" scripts/install-docker.sh` — official apt repo present
4. `grep "raspbian" scripts/install-docker.sh` — distro fallback mapping present
5. `grep "docker run hello-world" scripts/install-docker.sh` — returns nothing (not called in bootstrap)
6. `grep "newgrp" scripts/install-docker.sh` — returns nothing (not used)
7. `grep "usermod -aG docker" scripts/install-docker.sh` — docker group membership present
8. `grep "re-login" scripts/install-docker.sh` — re-login warning present
9. `grep "lazydocker.*flat\|flat.*lazydocker\|# lazydocker is a FLAT" scripts/install-docker.sh` — flat archive comment present
10. `grep "LAZYDOCKER_VERSION" scripts/install-docker.sh` — version from versions.sh used
</verification>

<success_criteria>
scripts/install-docker.sh is a syntactically valid bash file with four functions. Docker Engine is installed via official apt repo with proper distro detection for both Ubuntu and RPi OS arm64. docker group is added with re-login warning. lazydocker is installed from GitHub Releases using flat archive extraction. No docker run hello-world inside bootstrap.
</success_criteria>

<output>
After completion, create `.planning/phases/03-cli-tools-and-docker/03-03-SUMMARY.md`
</output>
