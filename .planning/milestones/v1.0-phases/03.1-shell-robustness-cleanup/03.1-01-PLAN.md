---
phase: 03.1-shell-robustness-cleanup
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/install-shell.sh
  - .planning/REQUIREMENTS.md
autonomous: true
requirements:
  - BOOT-02
  - SHELL-03
  - SHELL-04

must_haves:
  truths:
    - "Running bootstrap.sh a second time does NOT re-download starship — install_starship() returns early and logs a skip message"
    - "Running bootstrap.sh a second time shows tmux under Skipped in the final summary, not under Installed"
    - "All binary-download installers in install-shell.sh use the shared _already_installed helper for their skip guard"
    - "REQUIREMENTS.md traceability row for MAINT-01 shows Phase 3 (verified correct, no edit needed)"
  artifacts:
    - path: "scripts/install-shell.sh"
      provides: "_already_installed helper + fixed install_starship() + fixed install_tmux()"
      contains: "_already_installed"
    - path: ".planning/REQUIREMENTS.md"
      provides: "MAINT-01 traceability confirmation"
      contains: "MAINT-01 | Phase 3"
  key_links:
    - from: "install_starship()"
      to: "_already_installed"
      via: "function call at top of install_starship body"
      pattern: "_already_installed.*starship"
    - from: "install_tmux()"
      to: "pkg_installed tmux"
      via: "pre-check before pkg_install tmux"
      pattern: "pkg_installed tmux"
---

<objective>
Fix two idempotency defects in scripts/install-shell.sh so that re-running bootstrap.sh correctly skips already-installed tools and reports them as Skipped in the summary. Also verify that REQUIREMENTS.md already has MAINT-01 mapped to Phase 3.

Purpose: BOOT-02 requires bootstrap to be idempotent with no side effects on re-run. Currently, install_starship() unconditionally re-downloads starship on every run and install_tmux() always appends to the Installed summary even when tmux was already present — both are correctness failures.

Output: Updated scripts/install-shell.sh with _already_installed helper + corrected install_starship() and install_tmux(). REQUIREMENTS.md traceability confirmed (verify only).
</objective>

<execution_context>
@/Users/elmartinez85/.claude/get-shit-done/workflows/execute-plan.md
@/Users/elmartinez85/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@scripts/install-shell.sh
@lib/pkg.sh
@lib/log.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add _already_installed helper and fix install_starship()</name>
  <files>scripts/install-shell.sh</files>
  <action>
Read the current scripts/install-shell.sh in full before making any edits.

**Step 1 — Add _already_installed helper**

Insert the following helper function at the top of scripts/install-shell.sh, BEFORE the first installer function (install_zsh). Place it after the double-source guard block (after line `_SCRIPT_INSTALL_SHELL_LOADED=1`) and before the `# ── Function 1: install_zsh` section. Follow the existing naming convention: internal helpers use underscore prefix.

```bash
# ── Helper: _already_installed ─────────────────────────────────────────────────
# _already_installed <install_path> <label>
#
# Returns 0 (skip) if binary exists at install_path.
# On skip: logs inline skip message and appends label to _SUMMARY_SKIPPED.
# Returns 1 (proceed) if binary is absent.
#
# Use this helper for binary-download installers only.
# apt-managed tools (zsh, tmux) use pkg_installed instead.
_already_installed() {
  local install_path="$1"
  local label="$2"
  if [[ -f "$install_path" ]]; then
    log_info "${label} already installed — skipping"
    _SUMMARY_SKIPPED+=("${label}")
    return 0
  fi
  return 1
}
```

Use `[[ -f "$install_path" ]]` (not `[[ -x ]]`) per the CONTEXT.md locked decision. Do NOT place this in lib/ — it is install-script-internal, not a reusable library primitive.

**Step 2 — Fix install_starship()**

Replace the current install_starship() body with a version that calls _already_installed before proceeding. The install path is `/usr/local/bin/starship` (confirmed from the existing `echo "file:/usr/local/bin/starship" >> "$MANIFEST_FILE"` line in the current code).

The corrected function:

```bash
# ── Function 3: install_starship ───────────────────────────────────────────────
# Installs the starship prompt via the official install script.
# Idempotency: binary presence at /usr/local/bin/starship is the skip guard.
# Loose check only (no version comparison) — per CONTEXT.md locked decision.
install_starship() {
  local install_path="/usr/local/bin/starship"

  log_step "Checking starship..."

  if _already_installed "$install_path" "starship"; then
    return 0
  fi

  if [[ "${DRY_RUN:-false}" == "true" ]]; then
    log_info "[DRY RUN] Would install starship via official install script"
    return 0
  fi

  curl -fsSL https://starship.rs/install.sh | sh -s -- --yes

  log_success "starship installed at $(command -v starship)"
  echo "file:${install_path}" >> "$MANIFEST_FILE"
  _SUMMARY_INSTALLED+=("starship")
}
```

Note: The DRY_RUN check is placed AFTER the already-installed check so that dry runs on already-installed systems also short-circuit cleanly (they return 0 from _already_installed before reaching DRY_RUN). This is consistent with how install_ohmyzsh handles the same order.

Do NOT change the log_step text in other functions — only install_starship() is being modified here.
  </action>
  <verify>
Run: `grep -n "_already_installed" /Users/elmartinez85/Documents/Repositories/server-dotfiles/scripts/install-shell.sh`

Expected output: at least 3 matches —
- The helper function definition line
- The `if _already_installed "$install_path" "starship"` call inside install_starship()
- The helper body's `if [[ -f "$install_path" ]]` line

Also run: `bash -n /Users/elmartinez85/Documents/Repositories/server-dotfiles/scripts/install-shell.sh`

Expected: exits 0 with no output (syntax valid).
  </verify>
  <done>
scripts/install-shell.sh passes `bash -n` syntax check. _already_installed helper is defined before install_zsh. install_starship() calls `_already_installed "/usr/local/bin/starship" "starship"` as its first action and returns 0 on skip. The function no longer unconditionally calls the starship.rs install script.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix install_tmux() and verify MAINT-01 traceability</name>
  <files>scripts/install-shell.sh, .planning/REQUIREMENTS.md</files>
  <action>
**Part A — Fix install_tmux()**

Read the current install_tmux() in scripts/install-shell.sh. The bug: `pkg_install tmux` is called first, THEN `pkg_installed tmux` is checked — but `pkg_installed` is always true after `pkg_install` whether or not tmux was already present. This causes tmux to always appear under Installed in the summary.

The fix: check `pkg_installed tmux` BEFORE calling `pkg_install tmux`, and branch to _SUMMARY_SKIPPED or _SUMMARY_INSTALLED accordingly.

Replace install_tmux() with:

```bash
# ── Function 4: install_tmux ───────────────────────────────────────────────────
# Installs tmux via apt.
# Idempotency: pkg_installed check BEFORE pkg_install determines correct summary bucket.
install_tmux() {
  log_step "Installing tmux..."

  if pkg_installed tmux; then
    log_info "tmux already installed — skipping"
    _SUMMARY_SKIPPED+=("tmux")
    return 0
  fi

  pkg_install tmux
  _SUMMARY_INSTALLED+=("tmux")
}
```

Do NOT use _already_installed here — tmux is an apt-managed package, not a binary download. Use `pkg_installed` (from lib/pkg.sh) which calls `dpkg-query -W -f='${Status}'` — the correct apt presence check.

Do NOT add a DRY_RUN guard — pkg_install already handles DRY_RUN internally via the exported DRY_RUN env var.

**Part B — Verify MAINT-01 traceability in REQUIREMENTS.md**

Read .planning/REQUIREMENTS.md and locate the MAINT-01 row in the Traceability table (around line 127).

If the row reads `| MAINT-01 | Phase 3 | Complete |` — no edit is needed. The task is complete as a verification.

If the row reads `| MAINT-01 | Phase 4 | ...` — correct it to `| MAINT-01 | Phase 3 | Complete |`.

Based on research (line 127 of REQUIREMENTS.md confirmed correct as of 2026-02-22), this is expected to be a verify-only action. Read the file and confirm before deciding whether to write.
  </action>
  <verify>
Run: `grep -A3 "install_tmux" /Users/elmartinez85/Documents/Repositories/server-dotfiles/scripts/install-shell.sh | head -20`

Expected: shows `pkg_installed tmux` check BEFORE `pkg_install tmux` call (not after).

Run: `bash -n /Users/elmartinez85/Documents/Repositories/server-dotfiles/scripts/install-shell.sh`

Expected: exits 0, no output.

Run: `grep "MAINT-01" /Users/elmartinez85/Documents/Repositories/server-dotfiles/.planning/REQUIREMENTS.md`

Expected: output contains `Phase 3` (not Phase 4).
  </verify>
  <done>
install_tmux() checks `pkg_installed tmux` BEFORE calling `pkg_install tmux`. On a re-run where tmux is already present, the function returns 0 and appends to _SUMMARY_SKIPPED. REQUIREMENTS.md MAINT-01 row confirmed to show Phase 3. scripts/install-shell.sh passes bash -n syntax check.
  </done>
</task>

</tasks>

<verification>
Run the following checks after both tasks complete:

1. Syntax: `bash -n scripts/install-shell.sh` — exits 0, no errors

2. Helper present and ordered before callers:
   `grep -n "^_already_installed\|^install_zsh\|^install_starship" scripts/install-shell.sh`
   Expected: _already_installed appears at a LOWER line number than install_zsh and install_starship

3. Starship skip guard: `grep -A5 "^install_starship" scripts/install-shell.sh`
   Expected: first meaningful line inside function body is `local install_path` then `if _already_installed`

4. Tmux pre-check: `grep -B1 -A8 "^install_tmux" scripts/install-shell.sh`
   Expected: `pkg_installed tmux` check appears BEFORE `pkg_install tmux` call

5. MAINT-01 traceability: `grep "MAINT-01" .planning/REQUIREMENTS.md`
   Expected: `| MAINT-01 | Phase 3 | Complete |`

6. No _already_installed calls in install_ohmyzsh, install_zsh, install_zsh_plugins, or deploy_dotfiles — those functions use directory/shell/symlink guards, not binary path checks:
   `grep "_already_installed" scripts/install-shell.sh`
   Expected: lines in helper definition + install_starship only
</verification>

<success_criteria>
- scripts/install-shell.sh has _already_installed() helper defined before install_zsh()
- install_starship() returns 0 without network access if /usr/local/bin/starship exists
- install_tmux() appends to _SUMMARY_SKIPPED (not _SUMMARY_INSTALLED) on re-run when tmux is already installed
- All three targeted defects addressed; no unrelated changes to install-tools.sh or other scripts
- bash -n syntax check passes on scripts/install-shell.sh
- REQUIREMENTS.md MAINT-01 row confirmed as Phase 3
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-shell-robustness-cleanup/03.1-01-SUMMARY.md`
</output>
