---
phase: 03.1-shell-robustness-cleanup
plan: "01"
subsystem: shell-installer
tags: [idempotency, install-shell, starship, tmux, bash]
dependency_graph:
  requires: []
  provides: [_already_installed helper, fixed install_starship(), fixed install_tmux()]
  affects: [scripts/install-shell.sh]
tech_stack:
  added: []
  patterns: [_already_installed binary skip guard, pkg_installed pre-check for apt tools]
key_files:
  created: []
  modified:
    - scripts/install-shell.sh
decisions:
  - "_already_installed uses [[ -f ]] not [[ -x ]] (locked decision from CONTEXT.md)"
  - "_already_installed placed in install-shell.sh (not lib/) — install-script-internal, not a reusable library primitive"
  - "DRY_RUN check in install_starship() placed AFTER already-installed check — consistent with install_ohmyzsh pattern"
  - "install_tmux() uses pkg_installed (not _already_installed) — apt-managed tool, not a binary download"
  - "REQUIREMENTS.md MAINT-01 verified as Phase 3 — no edit required (already correct)"
metrics:
  duration: "1 min"
  completed: "2026-02-23"
  tasks_completed: 2
  files_modified: 1
---

# Phase 3.1 Plan 01: Shell Idempotency Fixes Summary

**One-liner:** Added `_already_installed` binary-skip helper and corrected `install_starship()` and `install_tmux()` so re-running bootstrap.sh neither re-downloads starship nor misclassifies tmux as freshly installed.

## What Was Built

Fixed two idempotency defects in `scripts/install-shell.sh`:

1. **_already_installed helper** — New internal helper function placed between the double-source guard and `install_zsh()`. Takes an install path and label; checks file existence with `[[ -f ]]`, logs a skip message, appends to `_SUMMARY_SKIPPED`, and returns 0. Returns 1 if binary is absent. Intended for binary-download installers only.

2. **install_starship() fix** — Replaced unconditional curl-to-sh download with a `_already_installed "/usr/local/bin/starship" "starship"` check as the first action. On re-run where the binary exists, the function returns 0 immediately without network access.

3. **install_tmux() fix** — Replaced post-install `pkg_installed` check (which was always true after `pkg_install`) with a pre-install check. On re-run where tmux is already present, the function returns 0 and appends to `_SUMMARY_SKIPPED` — correctly shown as Skipped in the bootstrap summary, not Installed.

## Commits

| Task | Commit | Description |
|------|--------|-------------|
| Task 1 | 65281b7 | feat(03.1-01): add _already_installed helper and fix install_starship() |
| Task 2 | d87a368 | fix(03.1-01): fix install_tmux() pre-check ordering for correct summary bucket |

## Verification Results

All 6 plan verification checks passed:

1. `bash -n scripts/install-shell.sh` — exits 0, no syntax errors
2. `_already_installed` defined at line 20 — before `install_zsh` (line 36) and `install_starship` (line 112)
3. `install_starship()` first meaningful lines: `local install_path` then `if _already_installed`
4. `install_tmux()`: `pkg_installed tmux` check appears BEFORE `pkg_install tmux` call
5. MAINT-01 in REQUIREMENTS.md: `| MAINT-01 | Phase 3 | Complete |` — confirmed correct
6. `_already_installed` call sites: helper definition + `install_starship()` only — no leakage to apt/directory-managed functions

## Deviations from Plan

None — plan executed exactly as written.

## Requirements Addressed

| Requirement | Description | Status |
|-------------|-------------|--------|
| BOOT-02 | Bootstrap script is idempotent — safe to re-run without side effects | Defects fixed |
| SHELL-03 | starship prompt installed (now skips on re-run correctly) | Improved |
| SHELL-04 | tmux installed (now correctly reports Skipped on re-run) | Improved |

## Self-Check: PASSED

- FOUND: scripts/install-shell.sh
- FOUND: .planning/phases/03.1-shell-robustness-cleanup/03.1-01-SUMMARY.md
- FOUND commit 65281b7: feat(03.1-01): add _already_installed helper and fix install_starship()
- FOUND commit d87a368: fix(03.1-01): fix install_tmux() pre-check ordering for correct summary bucket
