# Phase 3.1: Shell Installer Robustness - Research

**Researched:** 2026-02-22
**Domain:** Bash idempotency patterns, shell installer functions
**Confidence:** HIGH

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions

- **Starship version check:** Loose check — if the starship binary exists at all, skip re-download (no version pinning). Exactly what "installed" means (binary presence) is Claude's call based on how bootstrap.sh installs it. How to handle version mismatch is Claude's call based on codebase conventions.
- **Skip detection pattern:** Standardize across ALL tool installers in bootstrap.sh, not just starship and tmux. Use a shared helper function (e.g., `is_installed()` or `already_installed()`) called by each installer. Skip check uses explicit path check (`test -f <install_path>`) rather than `command -v`.
- **Log and summary output:** Log messages must match the existing log style in bootstrap.sh (format, prefix conventions). Skip must appear BOTH inline (during execution) AND in the final summary. Color/ANSI formatting must match conventions already in bootstrap.sh.

### Claude's Discretion

- Exact binary/path for starship's installed location (inspect bootstrap.sh)
- How skip status is tracked for summary aggregation
- Summary section layout (Installed vs Skipped visual structure)
- Color usage for skip messages

### Deferred Ideas (OUT OF SCOPE)

None — discussion stayed within phase scope.
</user_constraints>

<phase_requirements>
## Phase Requirements

| ID | Description | Research Support |
|----|-------------|-----------------|
| BOOT-02 | Bootstrap script is idempotent — safe to re-run on an existing server without side effects | install_starship() and install_tmux() currently do not correctly skip on re-run; fixing both closes this gap |
| SHELL-03 | User has starship prompt installed and active in zsh | install_starship() must detect the already-present binary and skip re-download |
| SHELL-04 | User has tmux installed | install_tmux() must track skip status via _SUMMARY_SKIPPED, not _SUMMARY_INSTALLED, on re-run |
</phase_requirements>

---

## Summary

Phase 3.1 is a targeted code-correctness gap-closure across three precise defects in `scripts/install-shell.sh` and `REQUIREMENTS.md`. No new tools or install targets are introduced. The work is purely internal: fix idempotency behavior in two installer functions, extract a shared skip-check helper, and correct a documentation traceability entry.

**Defect 1 — install_starship():** The function unconditionally runs the starship.rs install script (`curl ... | sh -s -- --yes`) on every bootstrap invocation. No binary-presence check exists. The official starship installer is idempotent in the sense that it overwrites the binary harmlessly, but this causes an unnecessary network fetch and download on every re-run. The fix is to add a binary-presence guard: if `/usr/local/bin/starship` exists, log skip and return 0 — consistent with the loose-check decision locked in CONTEXT.md.

**Defect 2 — install_tmux():** The function calls `pkg_install tmux` (which IS idempotent) and then always appends to `_SUMMARY_INSTALLED` regardless of whether tmux was already present. `pkg_install` does not write to `_SUMMARY_SKIPPED` — it only calls `log_info "tmux already installed — skipping"`. So on a re-run, tmux appears in the "Installed" summary section instead of "Skipped". The fix is to check `pkg_installed tmux` BEFORE calling `pkg_install`, branching into either `_SUMMARY_SKIPPED` or `_SUMMARY_INSTALLED` accordingly.

**Defect 3 — REQUIREMENTS.md traceability:** The MAINT-01 row already shows `Phase 3` in REQUIREMENTS.md (line 127). The file was corrected at the bottom comment (line 137) but a deeper review reveals the traceability table itself is already correct. The task for the plan is to verify the table entry and confirm no edit is needed, or make the correction if the traceability row is still wrong in working copy.

**Primary recommendation:** Fix install_starship() with a binary-presence guard matching the pattern used in install_zsh(), extract an `_already_installed` helper (binary path + summary tracking in one call) since the decision requires standardization across ALL installers, and fix install_tmux() to branch on pkg_installed before assigning to the correct summary array.

---

## Standard Stack

### Core

| Component | Version/Source | Purpose | Why Standard |
|-----------|---------------|---------|--------------|
| bash arrays `_SUMMARY_INSTALLED` / `_SUMMARY_SKIPPED` | Already in bootstrap.sh | Accumulate summary output for `_print_summary` | Project-established pattern; planner must not invent new tracking mechanism |
| `pkg_installed` (lib/pkg.sh) | Already in codebase | Idempotency check for apt packages | Used by pkg_install internally; available to callers |
| `log_info` / `log_success` | lib/log.sh | Inline skip/install messages | Established project log style |
| `test -f <path>` / `[[ -x <path> ]]` | bash built-in | Binary presence check | CONTEXT.md locked decision; matches install_ripgrep/fd/fzf/eza/bat/delta/nvim pattern |

### Supporting

| Component | Purpose | When to Use |
|-----------|---------|-------------|
| Shared helper `_already_installed path label` | Centralize binary-presence guard + summary append | Called by each installer in install-shell.sh to implement CONTEXT.md standardization requirement |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| `test -f /path` | `command -v tool` | CONTEXT.md explicitly locks `test -f <install_path>` over `command -v`; do not deviate |
| Version-match skip | Binary-presence-only skip | CONTEXT.md explicitly locks loose check for starship; version-match pattern (used in install-tools.sh) is correct for Phase 3 tools but NOT for starship |

---

## Architecture Patterns

### Existing Idempotency Pattern in install-tools.sh (reference implementation)

All seven Phase 3 tool installers (ripgrep, fd, fzf, eza, bat, delta, nvim) follow this identical pattern:

```bash
install_<tool>() {
  local version="${<TOOL>_VERSION}"
  local install_path="/usr/local/bin/<tool>"

  log_step "Checking <tool> ${version}..."

  # Idempotency: skip if binary exists AND version matches
  if [[ -x "$install_path" ]]; then
    local installed_ver
    installed_ver="$("$install_path" --version 2>/dev/null | head -1 || echo "unknown")"
    if [[ "$installed_ver" == *"${version}"* ]]; then
      log_info "<tool> ${version} already installed — skipping"
      _SUMMARY_SKIPPED+=("<tool> ${version}")
      return 0
    fi
    log_info "<tool> version mismatch — reinstalling"
  fi
  # ... download and install ...
  _SUMMARY_INSTALLED+=("<tool> ${version}")
}
```

**For starship**, the decision is LOOSE (binary presence only, no version comparison). The simplified pattern is:

```bash
install_starship() {
  local install_path="/usr/local/bin/starship"

  log_step "Checking starship..."

  if [[ -f "$install_path" ]]; then
    log_info "starship already installed — skipping"
    _SUMMARY_SKIPPED+=("starship")
    return 0
  fi

  if [[ "${DRY_RUN:-false}" == "true" ]]; then
    log_info "[DRY RUN] Would install starship via official install script"
    return 0
  fi

  curl -fsSL https://starship.rs/install.sh | sh -s -- --yes

  log_success "starship installed at $(command -v starship)"
  echo "file:${install_path}" >> "$MANIFEST_FILE"
  _SUMMARY_INSTALLED+=("starship")
}
```

Note: `[[ -f "$install_path" ]]` satisfies the CONTEXT.md locked decision for explicit path check. The existing code already uses `echo "file:/usr/local/bin/starship" >> "$MANIFEST_FILE"` which confirms `/usr/local/bin/starship` is the correct install path for this project.

### Existing apt Package Idempotency Pattern (install_zsh reference)

install_zsh() demonstrates the correct two-branch pattern for apt-managed tools:

```bash
install_zsh() {
  # ...
  if [[ "$current_shell" == "$zsh_path" ]]; then
    log_info "zsh already default shell for ${target_user} — skipping"
    _SUMMARY_SKIPPED+=("zsh default shell")
    return 0
  fi
  # ... install ...
  _SUMMARY_INSTALLED+=("zsh (default shell for ${target_user})")
}
```

**For install_tmux()**, the equivalent fix checks `pkg_installed tmux` before calling `pkg_install`:

```bash
install_tmux() {
  log_step "Installing tmux..."
  if pkg_installed tmux; then
    log_info "tmux already installed — skipping"
    _SUMMARY_SKIPPED+=("tmux")
    return 0
  fi
  pkg_install tmux
  _SUMMARY_INSTALLED+=("tmux")
}
```

### Shared Helper for Standardization (CONTEXT.md requirement)

CONTEXT.md locks "standardize across ALL tool installers in bootstrap.sh ... use a shared helper function". The helper must encapsulate the path-check-and-log pattern. Based on existing code conventions in lib/pkg.sh and install-tools.sh, the helper should live in `scripts/install-shell.sh` (the file being modified) rather than lib/, since it is specific to the installer functions, not a reusable library primitive.

Proposed signature: `_already_installed <install_path> <label>`

```bash
# Returns 0 (skip) if binary exists at install_path; 1 (proceed) if not.
# On skip: logs inline message and appends label to _SUMMARY_SKIPPED.
_already_installed() {
  local install_path="$1"
  local label="$2"
  if [[ -f "$install_path" ]]; then
    log_info "${label} already installed — skipping"
    _SUMMARY_SKIPPED+=("${label}")
    return 0
  fi
  return 1
}
```

Callers use: `if _already_installed "$install_path" "starship"; then return 0; fi`

**Important scoping note:** The helper only applies to BINARY installers. The `install_tmux` and `install_zsh` functions use pkg_installed (apt-based check) — they should NOT be refactored to call this helper. Standardization means all BINARY download installers use the helper; apt-managed tools retain their existing pkg_installed pattern.

### Anti-Patterns to Avoid

- **Never call `_SUMMARY_INSTALLED+=` unconditionally after pkg_install:** pkg_install returns 0 whether it installed or skipped. Callers must branch on pkg_installed first.
- **Never use `command -v`** for the skip guard: CONTEXT.md explicitly locked `test -f <install_path>`.
- **Do not move the helper to lib/:** lib/ files are sourced globally and have idempotency guards. This helper is install-script-internal.

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| apt package presence check | `dpkg -l | grep` | `pkg_installed` from lib/pkg.sh | Already exists; handles dpkg-query correctly |
| Logging | Custom echo + color escape codes | `log_info`, `log_success`, `log_warn` from lib/log.sh | Already abstracts terminal-vs-pipe color detection |
| Summary accumulation | New data structures | Append to existing `_SUMMARY_SKIPPED[]` / `_SUMMARY_INSTALLED[]` arrays | _print_summary already consumes these |

---

## Common Pitfalls

### Pitfall 1: pkg_install Return Value Does Not Distinguish Install vs Skip

**What goes wrong:** Calling `pkg_install tmux; _SUMMARY_INSTALLED+=(tmux)` always appends to Installed even when pkg_install skipped. This is the exact current bug in install_tmux().

**Why it happens:** `pkg_install` is a fire-and-forget helper. It returns 0 in both "installed" and "already present" cases. It has no output variable or side effect that the caller can inspect.

**How to avoid:** Always call `pkg_installed <pkg>` BEFORE calling `pkg_install`. Branch on its result to decide which summary array to update.

**Warning sign:** A tool appears under "Installed" on a second bootstrap run.

### Pitfall 2: [[ -x path ]] vs [[ -f path ]] for Skip Guard

**What goes wrong:** install-tools.sh uses `[[ -x "$install_path" ]]` (executable check). CONTEXT.md locks `test -f <install_path>` for the new helper.

**Why it happens:** `[[ -x ]]` is strictly more correct for detecting runnable binaries. However, CONTEXT.md explicitly chose `test -f` (exists, any permissions). The two are equivalent when `install -m 755` is used (all installed binaries are executable), so the behavioral difference is zero in this codebase.

**How to avoid:** Use `[[ -f "$install_path" ]]` in `_already_installed` per CONTEXT.md. Do NOT change existing install-tools.sh functions to use -f; they were written before this decision.

### Pitfall 3: Starship Install Path Mismatch

**What goes wrong:** If the skip guard checks the wrong path, it never triggers.

**Why it doesn't happen here:** The existing install_starship() already writes `echo "file:/usr/local/bin/starship" >> "$MANIFEST_FILE"`. This confirms the starship installer places the binary at `/usr/local/bin/starship`. The skip guard must check this exact path.

**Verification:** `ls -la /usr/local/bin/starship` after bootstrap confirms the path.

### Pitfall 4: Helper Placement Breaking set -eEuo pipefail

**What goes wrong:** If the helper is defined AFTER it is called, bash will error with "command not found" under strict mode.

**How to avoid:** Define `_already_installed` at the TOP of install-shell.sh, before any installer function that calls it. Follow the existing pattern of helper-before-caller ordering in install-tools.sh (`_arch_for_tool` and `_try_install` are defined before the install functions that call them).

### Pitfall 5: MAINT-01 Traceability Already Correct

**What goes wrong:** Spending time editing REQUIREMENTS.md when it does not need edits.

**Finding:** Line 127 of REQUIREMENTS.md already shows `| MAINT-01 | Phase 3 | Complete |`. The traceability table is ALREADY CORRECT as of the last session (2026-02-22). The bottom comment on line 137 says "MAINT-01 corrected to Phase 3". No edit is required to the table itself.

**How to avoid:** Verify the current file content before making a "fix". If MAINT-01 row already shows Phase 3, the plan task for this item is verify-only (confirm, no edit needed).

---

## Code Examples

Verified patterns from the existing codebase:

### Current install_starship() (broken — no skip guard)

```bash
# Source: scripts/install-shell.sh lines 92-105
install_starship() {
  log_step "Installing starship..."

  if [[ "${DRY_RUN:-false}" == "true" ]]; then
    log_info "[DRY RUN] Would install starship via official install script"
    return 0
  fi

  curl -fsSL https://starship.rs/install.sh | sh -s -- --yes

  log_success "starship installed at $(command -v starship)"
  echo "file:/usr/local/bin/starship" >> "$MANIFEST_FILE"
  _SUMMARY_INSTALLED+=("starship")
}
```

### Current install_tmux() (broken — always appends to INSTALLED)

```bash
# Source: scripts/install-shell.sh lines 109-120
install_tmux() {
  log_step "Installing tmux..."
  pkg_install tmux
  if pkg_installed tmux; then
    # Comment says "if it returned 0 after the dpkg-query skip"
    # BUG: This condition is ALWAYS true after pkg_install — whether installed or skipped
    _SUMMARY_INSTALLED+=("tmux")
  fi
}
```

**Root cause analysis:** The comment in install_tmux() reveals the original author understood the ambiguity but got the branch logic wrong. `pkg_installed tmux` returns true AFTER `pkg_install tmux` regardless of whether this run installed it or found it already present. The check needs to happen BEFORE pkg_install, not after.

### pkg_installed (available for pre-check)

```bash
# Source: lib/pkg.sh lines 10-13
pkg_installed() {
  local pkg="$1"
  dpkg-query -W -f='${Status}' "$pkg" 2>/dev/null | grep -q "install ok installed"
}
```

### _print_summary (consumes _SUMMARY_SKIPPED)

```bash
# Source: bootstrap.sh lines 101-122
_print_summary() {
  echo ""
  log_step "Bootstrap Complete"
  if [[ ${#_SUMMARY_INSTALLED[@]} -gt 0 ]]; then
    log_success "Installed:"
    for item in "${_SUMMARY_INSTALLED[@]}"; do
      echo "    - ${item}"
    done
  fi
  if [[ ${#_SUMMARY_SKIPPED[@]} -gt 0 ]]; then
    log_info "Skipped (already present):"
    for item in "${_SUMMARY_SKIPPED[@]}"; do
      echo "    - ${item}"
    done
  fi
  # ...
}
```

This confirms the summary structure: Installed section, then Skipped section. The label in `_SUMMARY_SKIPPED` becomes the displayed text under "Skipped (already present):".

---

## State of the Art

| Current State | After Phase 3.1 | Impact |
|---------------|-----------------|--------|
| install_starship() always re-downloads | Binary presence guard skips download if /usr/local/bin/starship exists | BOOT-02 correctly satisfied for starship |
| install_tmux() always adds to Installed summary | Pre-check with pkg_installed branches to Skipped or Installed | BOOT-02 correctly satisfied for tmux; summary accurate |
| No shared helper for binary-presence checks | _already_installed helper standardizes pattern across all binary installers in install-shell.sh | Consistent codebase, CONTEXT.md requirement met |
| MAINT-01 traceability row in REQUIREMENTS.md | Verify it already shows Phase 3 (confirmed correct as of last session) | No edit needed; plan task is confirm-only |

---

## Open Questions

1. **Which installer functions in install-shell.sh should call _already_installed?**
   - What we know: install_ohmyzsh and install_zsh_plugins already have their own directory-based guards. install_zsh checks current shell via getent. install_starship and install_tmux are the broken ones.
   - What's unclear: CONTEXT.md says "standardize across ALL tool installers in bootstrap.sh" — does this mean install-tools.sh functions should also be refactored to call the helper? Or only install-shell.sh functions?
   - Recommendation: Scope the helper to install-shell.sh only. install-tools.sh functions already have correct idempotency with version-match checking (a stricter pattern). Retrofitting them to use _already_installed would be a regression (version-match check would be lost). Standardization means all BINARY installers in install-shell.sh use _already_installed; install-tools.sh keeps its existing pattern.

2. **Does the MAINT-01 traceability row need an edit?**
   - What we know: Line 127 of REQUIREMENTS.md currently reads `| MAINT-01 | Phase 3 | Complete |`. This is already correct.
   - What's unclear: The phase goal says "MAINT-01 traceability correctly points to Phase 3 (not Phase 4)". The file already shows Phase 3.
   - Recommendation: Plan task should be "verify MAINT-01 row shows Phase 3" — if already correct, no edit is needed and the task closes as confirmed.

---

## Sources

### Primary (HIGH confidence)

- Direct code inspection: `/scripts/install-shell.sh` — confirmed exact defects in install_starship() and install_tmux()
- Direct code inspection: `/scripts/install-tools.sh` — confirmed reference idempotency pattern used by seven Phase 3 tools
- Direct code inspection: `/lib/pkg.sh` — confirmed pkg_installed signature and behavior
- Direct code inspection: `/lib/log.sh` — confirmed log_info format and color conventions
- Direct code inspection: `/bootstrap.sh` — confirmed _SUMMARY_INSTALLED/_SUMMARY_SKIPPED arrays and _print_summary structure
- Direct code inspection: `.planning/REQUIREMENTS.md` line 127 — confirmed MAINT-01 row already shows Phase 3
- Direct code inspection: `.planning/STATE.md` — confirmed accumulated decisions, no conflicting guidance

### Secondary (MEDIUM confidence)

- CONTEXT.md (user decisions) — locked choices verified against codebase conventions during inspection

---

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — all components are existing codebase patterns, no external dependencies
- Architecture: HIGH — patterns derived from direct code inspection of working reference implementations
- Pitfalls: HIGH — root causes confirmed by reading exact defective code, not inferred

**Research date:** 2026-02-22
**Valid until:** Indefinite — all findings are from the local codebase, not external sources
